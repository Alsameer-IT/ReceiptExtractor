<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remittance Receipt</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0.5rem;
        }

        .receipt-container {
            width: 100%;
            max-width: 800px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .receipt-header {
            background: #003087;
            color: white;
            padding: 0.8rem;
            text-align: center;
            border-bottom: 4px solid #ffd700;
            width: 100%;
        }

        .receipt-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            margin-bottom: 0.2rem;
        }

        .receipt-title img {
            width: 28px;
            height: auto;
        }

        .receipt-subtitle {
            font-size: 0.75rem;
            font-weight: 300;
            opacity: 0.9;
        }

        .top-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            width: 100%;
        }

        .top-details .detail-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.15rem;
            flex: 1;
        }

        .top-details .detail-key {
            font-size: 0.65rem;
            color: #666;
            font-weight: 400;
        }

        .top-details .detail-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #003087;
        }

        .top-details .pin-row .detail-key {
            color: #666;
            font-weight: 400;
        }

        .top-details .pin-row .detail-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #003087;
            background: #ffd700;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
        }

        .receipt-body {
            padding: 0.8rem;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .left-sections, .right-section {
            width: 48%;
        }

        .receipt-section {
            margin-bottom: 0.8rem;
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: #003087;
            margin-bottom: 0.6rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .section-title svg {
            width: 16px;
            height: 16px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            max-width: 100%;
            margin: 0 auto 0.4rem;
            font-size: 0.8rem;
        }

        .detail-row.hidden {
            display: none;
        }

        .detail-key {
            color: #666;
            font-weight: 400;
            text-align: left;
            flex: 1;
        }

        .detail-value {
            color: #222;
            font-weight: 500;
            text-align: left;
            flex: 1;
        }

        .amount-highlight {
            color: #003087;
            font-weight: 700;
        }

        .highlight-box {
            background: #e6f3ff;
            border: 1px solid #003087;
            padding: 0.3rem;
            border-radius: 4px;
            margin: 0.4rem auto;
            max-width: 100%;
        }

        .receipt-footer {
            text-align: center;
            padding: 0.6rem;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.7rem;
            color: #666;
            width: 100%;
        }

        .download-btn {
            background: #003087;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.8rem;
            width: 100%;
            max-width: 280px;
            margin: 0.6rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        .download-btn:hover {
            background: #002266;
        }

        .download-btn svg {
            width: 14px;
            height: 14px;
        }

        @media print {
            body {
                background: none;
            }
            .download-btn {
                display: none;
            }
            .receipt-container {
                box-shadow: none;
                border: none;
                height: auto;
                overflow: hidden;
                width: 100%;
            }
            .receipt-body {
                flex-direction: column;
            }
            .left-sections, .right-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="receipt-container" id="receiptContainer">
        <div class="receipt-header">
            <div class="receipt-title">
                <img id="countryFlag" src="https://flagcdn.com/w40/xx.png" alt="Country Flag">
                <span id="countryName">Unknown Country</span>
            </div>
            <div class="receipt-subtitle">Transaction Receipt</div>
        </div>
        
        <div class="top-details">
            <div class="detail-row">
                <div class="detail-key">Date</div>
                <div class="detail-value" id="date">N/A</div>
            </div>
            <div class="detail-row pin-row" id="pinRow">
                <div class="detail-key">Pin No</div>
                <div class="detail-value" id="pin"></div>
            </div>
            <div class="detail-row">
                <div class="detail-key">Reference Number</div>
                <div class="detail-value" id="referenceNumber"></div>
            </div>
        </div>
        
        <div class="receipt-body">
            <div class="left-sections">
                <div class="receipt-section">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Sender Details
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Sender Name</div>
                        <div class="detail-value" id="senderName"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Passport/IC No#</div>
                        <div class="detail-value" id="nationalId"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Occupation</div>
                        <div class="detail-value" id="occupation"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Phone/Mobile</div>
                        <div class="detail-value" id="senderMobile"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Address</div>
                        <div class="detail-value" id="senderAddress"></div>
                    </div>
                    <div class="detail-row" id="sourceRow">
                        <div class="detail-key">Source of Income</div>
                        <div class="detail-value" id="source"></div>
                    </div>
                </div>
                
                <div class="receipt-section">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Recipient Details
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Receiver Name</div>
                        <div class="detail-value" id="beneficiaryName"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Bank Name</div>
                        <div class="detail-value" id="bankName"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Account No</div>
                        <div class="detail-value" id="accountNo"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Beneficiary Country</div>
                        <div class="detail-value" id="recipientCountry"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Address</div>
                        <div class="detail-value" id="beneficiaryAddress"></div>
                    </div>
                    <div class="detail-row" id="mobileRow">
                        <div class="detail-key">Mobile</div>
                        <div class="detail-value" id="beneficiaryMobile"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Purpose of Remittance</div>
                        <div class="detail-value" id="purpose"></div>
                    </div>
                </div>
            </div>
            
            <div class="right-section">
                <div class="receipt-section">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Transaction Summary
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Collected Amount</div>
                        <div class="detail-value" id="totalAmount"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Service Charge</div>
                        <div class="detail-value" id="serviceCharge"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Send Amount</div>
                        <div class="detail-value" id="sendAmount"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Rate</div>
                        <div class="detail-value" id="exchangeRate"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Payment Type</div>
                        <div class="detail-value" id="paymentMethod"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-key">Premium</div>
                        <div class="detail-value" id="payoutAmount"></div>
                    </div>
                    <div class="highlight-box">
                        <div class="detail-row">
                            <div class="detail-key">Payout Amount</div>
                            <div class="detail-value amount-highlight" id="payoutAmountHighlight"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="receipt-footer">
            <p>Thank you for using our service.</p>
        </div>
        
        <button class="download-btn" id="downloadBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Download Receipt
        </button>
    </div>

    <script>
        // Country to flag mapping with aliases
        const countryFlagMap = {
            'india': { flag: 'https://flagcdn.com/w40/in.png', name: 'India', code: 'INDIA', currency: 'INR' },
            'indian': { flag: 'https://flagcdn.com/w40/in.png', name: 'India', code: 'INDIA', currency: 'INR' },
            'bangladesh': { flag: 'https://flagcdn.com/w40/bd.png', name: 'Bangladesh', code: 'BANGLADESH', currency: 'BDT' },
            'china': { flag: 'https://flagcdn.com/w40/cn.png', name: 'China', code: 'CHINA', currency: 'CNY' },
            'chinese': { flag: 'https://flagcdn.com/w40/cn.png', name: 'China', code: 'CHINA', currency: 'CNY' },
            'thailand': { flag: 'https://flagcdn.com/w40/th.png', name: 'Thailand', code: 'THAILAND', currency: 'THB' },
            'thai': { flag: 'https://flagcdn.com/w40/th.png', name: 'Thailand', code: 'THAILAND', currency: 'THB' },
            'indonesia': { flag: 'https://flagcdn.com/w40/id.png', name: 'Indonesia', code: 'INDONESIA', currency: 'IDR' },
            'indonesian': { flag: 'https://flagcdn.com/w40/id.png', name: 'Indonesia', code: 'INDONESIA', currency: 'IDR' },
            'philippines': { flag: 'https://flagcdn.com/w40/ph.png', name: 'Philippines', code: 'PHILIPPINES', currency: 'PHP' },
            'filipino': { flag: 'https://flagcdn.com/w40/ph.png', name: 'Philippines', code: 'PHILIPPINES', currency: 'PHP' },
            'pakistan': { flag: 'https://flagcdn.com/w40/pk.png', name: 'Pakistan', code: 'PAKISTAN', currency: 'PKR' },
            'pakistani': { flag: 'https://flagcdn.com/w40/pk.png', name: 'Pakistan', code: 'PAKISTAN', currency: 'PKR' },
            'sri lanka': { flag: 'https://flagcdn.com/w40/lk.png', name: 'Sri Lanka', code: 'SRI LANKA', currency: 'LKR' },
            'srilanka': { flag: 'https://flagcdn.com/w40/lk.png', name: 'Sri Lanka', code: 'SRI LANKA', currency: 'LKR' },
            'uae': { flag: 'https://flagcdn.com/w40/ae.png', name: 'UAE', code: 'UAE', currency: 'AED' },
            'united arab emirates': { flag: 'https://flagcdn.com/w40/ae.png', name: 'UAE', code: 'UAE', currency: 'AED' },
            'japan': { flag: 'https://flagcdn.com/w40/jp.png', name: 'Japan', code: 'JAPAN', currency: 'JPY' },
            'japanese': { flag: 'https://flagcdn.com/w40/jp.png', name: 'Japan', code: 'JAPAN', currency: 'JPY' },
            'south korea': { flag: 'https://flagcdn.com/w40/kr.png', name: 'South Korea', code: 'SOUTH KOREA', currency: 'KRW' },
            'korea': { flag: 'https://flagcdn.com/w40/kr.png', name: 'South Korea', code: 'SOUTH KOREA', currency: 'KRW' },
            'malaysia': { flag: 'https://flagcdn.com/w40/my.png', name: 'Malaysia', code: 'MALAYSIA', currency: 'MYR' },
            'malaysian': { flag: 'https://flagcdn.com/w40/my.png', name: 'Malaysia', code: 'MALAYSIA', currency: 'MYR' },
            'singapore': { flag: 'https://flagcdn.com/w40/sg.png', name: 'Singapore', code: 'SINGAPORE', currency: 'SGD' },
            'nepal': { flag: 'https://flagcdn.com/w40/np.png', name: 'Nepal', code: 'NEPAL', currency: 'NPR' },
            'nepali': { flag: 'https://flagcdn.com/w40/np.png', name: 'Nepal', code: 'NEPAL', currency: 'NPR' },
            'vietnam': { flag: 'https://flagcdn.com/w40/vn.png', name: 'Vietnam', code: 'VIETNAM', currency: 'VND' },
            'vietnamese': { flag: 'https://flagcdn.com/w40/vn.png', name: 'Vietnam', code: 'VIETNAM', currency: 'VND' },
            'united kingdom': { flag: 'https://flagcdn.com/w40/gb.png', name: 'United Kingdom', code: 'UNITED KINGDOM', currency: 'GBP' },
            'uk': { flag: 'https://flagcdn.com/w40/gb.png', name: 'United Kingdom', code: 'UNITED KINGDOM', currency: 'GBP' },
            'britain': { flag: 'https://flagcdn.com/w40/gb.png', name: 'United Kingdom', code: 'UNITED KINGDOM', currency: 'GBP' },
            'great britain': { flag: 'https://flagcdn.com/w40/gb.png', name: 'United Kingdom', code: 'UNITED KINGDOM', currency: 'GBP' }
        };

        // Extract URL parameters
        const params = new URLSearchParams(window.location.search);
        const payoutCountryRaw = params.get('payoutCountry') || 'N/A';
        const payoutCountryNormalized = payoutCountryRaw.toLowerCase().trim()
            .replace(/\s+/g, ' ')
            .replace(/^(the\s+)/i, '');

        // Try exact match first
        let countryDetails = countryFlagMap[payoutCountryNormalized];

        // If no exact match, try partial matches or common variations
        if (!countryDetails) {
            const countryKeys = Object.keys(countryFlagMap);
            for (const key of countryKeys) {
                if (payoutCountryNormalized.includes(key) || key.includes(payoutCountryNormalized)) {
                    countryDetails = countryFlagMap[key];
                    break;
                }
            }
        }

        // Fallback if no match is found
        if (!countryDetails) {
            console.warn(`Country not found in countryFlagMap: ${payoutCountryRaw}`);
            countryDetails = {
                flag: 'https://flagcdn.com/w40/xx.png',
                name: payoutCountryRaw.toUpperCase(),
                code: payoutCountryRaw.toUpperCase(),
                currency: 'CURRENCY'
            };
        }

        // Update header with country name and flag
        document.getElementById('countryFlag').src = countryDetails.flag;
        document.getElementById('countryFlag').alt = `${countryDetails.name} Flag`;
        document.getElementById('countryName').textContent = countryDetails.name;

        // Update recipient country in the "Recipient Details" section
        document.getElementById('recipientCountry').textContent = countryDetails.code;

        // Update payment method
        const paymentChannelRaw = params.get('paymentChannel') || 'N/A';
        let paymentMethod = paymentChannelRaw === 'N/A' ? 'Cash Pickup' : paymentChannelRaw;
        if (paymentMethod.toUpperCase() === 'REAL TIME' || paymentMethod.toUpperCase() === 'BANK TRANSFER') {
            paymentMethod = 'ACCOUNT CREDIT';
        }
        document.getElementById('paymentMethod').textContent = paymentMethod.toUpperCase();

        // Function to generate 2 random digits
        const randomDigits = () => Math.floor(Math.random() * 100).toString().padStart(2, '0');

        // Determine the Reference Number: prefer referenceNumber, then txn, then ref
        let referenceNumber = params.get('referenceNumber') || params.get('txn') || params.get('ref') || 'N/A';
        if (referenceNumber !== 'N/A' && !params.get('referenceNumber')) {
            const prefix = randomDigits();
            const suffix = randomDigits();
            referenceNumber = `${prefix}${referenceNumber}${suffix}`;
        }

        // Function to add commas to a number
        const addCommas = (numStr) => {
            const parts = numStr.split('.');
            const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.length > 1 ? `${integerPart}.${parts[1]}` : integerPart;
        };

        // Function to expand Brunei abbreviation
        const expandBrunei = (address) => {
            if (address.toUpperCase().includes('BRN')) {
                return address.replace(/BRN/gi, 'BRUNEI');
            }
            return address;
        };

        const data = {
            date: params.get('date') || 'N/A',
            referenceNumber: referenceNumber,
            totalAmount: params.get('totalAmount') ? addCommas(params.get('totalAmount').replace(/ BND$/, '')) : 'N/A',
            serviceCharge: params.get('serviceCharge') ? addCommas(params.get('serviceCharge').replace(/ BND$/, '')) : 'N/A',
            sendAmount: params.get('payInAmount') ? addCommas(params.get('payInAmount').replace(/ BND$/, '')) : 'N/A',
            exchangeRate: params.get('exchangeRate') ? `1 BND=${addCommas(params.get('exchangeRate').replace(/\s*[A-Z]{3}$/, ''))}` : 'N/A',
            payoutAmount: params.get('amount') ? `${addCommas(params.get('amount'))} ${countryDetails.currency}` : 'N/A',
            beneficiaryName: params.get('beneficiaryName') || 'N/A',
            bankName: params.get('bankName') || 'N/A',
            accountNo: params.get('accountNo') || 'N/A',
            beneficiaryAddress: countryDetails.code,
            beneficiaryMobile: params.get('beneficiaryMobile') || 'N/A',
            purpose: params.get('purpose') || 'N/A',
            senderName: params.get('senderName') || 'N/A',
            nationalId: params.get('nationalId') || 'N/A',
            occupation: params.get('profession') || 'N/A',
            senderMobile: params.get('senderMobile') ? `+673 ${params.get('senderMobile')}` : 'N/A',
            senderAddress: params.get('senderAddress') ? expandBrunei(params.get('senderAddress')) : 'N/A',
            source: params.get('source') || 'N/A',
            pin: params.get('pin') || 'N/A'
        };

        // Populate receipt with uppercase values
        document.getElementById('date').textContent = data.date.toUpperCase();
        document.getElementById('referenceNumber').textContent = data.referenceNumber.toUpperCase();
        document.getElementById('totalAmount').textContent = data.totalAmount.toUpperCase();
        document.getElementById('serviceCharge').textContent = data.serviceCharge.toUpperCase();
        document.getElementById('sendAmount').textContent = data.sendAmount.toUpperCase();
        document.getElementById('exchangeRate').textContent = data.exchangeRate.toUpperCase();
        document.getElementById('payoutAmount').textContent = data.payoutAmount.toUpperCase();
        document.getElementById('payoutAmountHighlight').textContent = data.payoutAmount.toUpperCase();
        document.getElementById('beneficiaryName').textContent = data.beneficiaryName.toUpperCase();
        document.getElementById('bankName').textContent = data.bankName.toUpperCase();
        document.getElementById('accountNo').textContent = data.accountNo.toUpperCase();
        document.getElementById('recipientCountry').textContent = data.beneficiaryAddress.toUpperCase();
        document.getElementById('beneficiaryAddress').textContent = data.beneficiaryAddress.toUpperCase();
        document.getElementById('beneficiaryMobile').textContent = data.beneficiaryMobile.toUpperCase();
        document.getElementById('purpose').textContent = data.purpose.toUpperCase();
        document.getElementById('senderName').textContent = data.senderName.toUpperCase();
        document.getElementById('nationalId').textContent = data.nationalId.toUpperCase();
        document.getElementById('occupation').textContent = data.occupation.toUpperCase();
        document.getElementById('senderMobile').textContent = data.senderMobile.toUpperCase();
        document.getElementById('senderAddress').textContent = data.senderAddress.toUpperCase();
        document.getElementById('source').textContent = data.source.toUpperCase();
        document.getElementById('pin').textContent = data.pin.toUpperCase();

        // Conditionally hide rows if values are "N/A"
        const mobileRow = document.getElementById('mobileRow');
        const sourceRow = document.getElementById('sourceRow');
        const pinRow = document.getElementById('pinRow');

        if (data.beneficiaryMobile.toUpperCase() === 'N/A') {
            mobileRow.classList.add('hidden');
        }
        if (data.source.toUpperCase() === 'N/A') {
            sourceRow.classList.add('hidden');
        }
        if (data.pin.toUpperCase() === 'N/A') {
            pinRow.classList.add('hidden');
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const element = document.getElementById('receiptContainer');
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.style.display = 'none';

            setTimeout(() => {
                const opt = {
                    margin: [0.5, 0.5, 0.5, 0.5],
                    filename: `Remittance_Receipt_${data.referenceNumber}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        scrollY: 0,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'in',
                        format: 'letter',
                        orientation: 'portrait'
                    }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    downloadBtn.style.display = 'flex';
                });
            }, 200);
        });

        if (params.get('autoDownload') === 'true') {
            document.getElementById('downloadBtn').click();
        }
    </script>
</body>
</html>